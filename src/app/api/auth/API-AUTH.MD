# üìò API Auth - Documenta√ß√£o

Documenta√ß√£o completa das fun√ß√µes dispon√≠veis no m√≥dulo de autentica√ß√£o.

---

## üì¶ Importa√ß√£o

```typescript
// Import tudo de uma vez
import { 
    // Tipos
    LoginCredentials,
    User,
    LoginResponse,
    RefreshTokenResponse,
    ActionResponse,
    AuthState,
    
    // Server Actions
    loginAction,
    logoutAction,
    getCurrentUser,
    isAuthenticated,
    refreshTokenAction,
    getAccessToken,
    
    // Schemas Zod
    loginSchema,
    recoverySchema,
    resetPasswordSchema,
    acceptInviteSchema,
} from '@/app/api/auth'
```

---

## üéØ Vis√£o Geral

O m√≥dulo de autentica√ß√£o √© **exclusivamente server-side** por seguran√ßa. N√£o possui:
- ‚ùå `auth.service.ts` - Credenciais nunca v√£o para o client
- ‚ùå `useAuth.ts` - Login/logout rodam no servidor

**Caracter√≠sticas**:
- ‚úÖ Cookies httpOnly (tokens seguros)
- ‚úÖ Server Actions apenas
- ‚úÖ Refresh autom√°tico de tokens
- ‚úÖ Valida√ß√£o Zod

---

## üìê Tipos

### `LoginCredentials`
```typescript
interface LoginCredentials {
    email: string
    password: string
}
```

### `User`
```typescript
interface User {
    id: string
    name: string
    email: string
    clientId: string | null  // null para admins
    role: 'admin' | 'operador' | 'gestor' | 'assistente'
    isAdmin: boolean
    isActive: boolean
}
```

### `ActionResponse<T>`
```typescript
interface ActionResponse<T = void> {
    success: boolean
    error?: string
    data?: T
}
```

---

## üîß Server Actions

### `loginAction(credentials)`

Realiza o login do usu√°rio.

**Par√¢metros:**
```typescript
credentials: LoginCredentials
```

**Retorno:**
```typescript
Promise<ActionResponse<{ user: User; accessToken: string; refreshToken: string }>>
```

**Exemplo:**
```typescript
'use server'
import { loginAction } from '@/app/api/auth'

// Em um formul√°rio ou Server Action
const result = await loginAction({
    email: 'user@example.com',
    password: 'senha123'
})

if (result.success) {
    console.log('Usu√°rio logado:', result.data.user)
    // Tokens salvos automaticamente em cookies
} else {
    console.error('Erro:', result.error)
}
```

**Comportamento:**
- ‚úÖ Valida email e senha
- ‚úÖ Chama API `/auth/login`
- ‚úÖ Salva tokens em cookies httpOnly
- ‚úÖ Salva dados do usu√°rio em cookie (n√£o httpOnly)
- ‚úÖ Retorna erro amig√°vel mapeado

**C√≥digos de erro mapeados:**
- `invalid_credentials` ‚Üí "Email ou senha incorretos"
- `invalid_inactive_user` ‚Üí "Sua conta est√° desativada"
- `credentials_required` ‚Üí "Email e senha s√£o obrigat√≥rios"
- `invalid_email_format` ‚Üí "Formato de email inv√°lido"

---

### `logoutAction()`

Realiza o logout do usu√°rio.

**Retorno:**
```typescript
Promise<ActionResponse>
```

**Exemplo:**
```typescript
'use server'
import { logoutAction } from '@/app/api/auth'

const result = await logoutAction()

if (result.success) {
    console.log('Logout realizado')
    // Cookies removidos
}
```

**Comportamento:**
- ‚úÖ Remove `access_token` cookie
- ‚úÖ Remove `refresh_token` cookie
- ‚úÖ Remove `user_data` cookie

---

### `getCurrentUser()`

Busca dados do usu√°rio logado do cookie.

**Retorno:**
```typescript
Promise<User | null>
```

**Exemplo:**
```typescript
import { getCurrentUser } from '@/app/api/auth'

// Em Server Component
export default async function ProfilePage() {
    const user = await getCurrentUser()
    
    if (!user) {
        redirect('/auth/login')
    }
    
    return <div>Ol√°, {user.name}!</div>
}
```

**Comportamento:**
- ‚úÖ L√™ cookie `user_data`
- ‚úÖ Retorna `User` ou `null`
- ‚úÖ √ötil para Server Components

---

### `isAuthenticated()`

Verifica se o usu√°rio est√° autenticado.

**Retorno:**
```typescript
Promise<boolean>
```

**Exemplo:**
```typescript
import { isAuthenticated } from '@/app/api/auth'

// Em middleware ou Server Component
export default async function ProtectedPage() {
    const authenticated = await isAuthenticated()
    
    if (!authenticated) {
        redirect('/auth/login')
    }
    
    return <ProtectedContent />
}
```

**Comportamento:**
- ‚úÖ Verifica exist√™ncia de `access_token`
- ‚úÖ Retorna `true` ou `false`

---

### `refreshTokenAction()`

Renova o accessToken usando o refreshToken.

**Retorno:**
```typescript
Promise<ActionResponse<{ accessToken: string }>>
```

**Exemplo:**
```typescript
import { refreshTokenAction } from '@/app/api/auth'

const result = await refreshTokenAction()

if (result.success) {
    console.log('Token renovado')
} else {
    console.error('Token expirado, fazer login novamente')
}
```

**Comportamento:**
- ‚úÖ Usa `refresh_token` do cookie
- ‚úÖ Chama API `/auth/refresh-token`
- ‚úÖ Atualiza `access_token` cookie
- ‚úÖ Se falhar, faz logout autom√°tico

**C√≥digos de erro que causam logout:**
- `invalid_refresh_token`
- `user_not_found`
- `user_inactive`

---

### `getAccessToken()`

Pega o access token atual do cookie.

**Retorno:**
```typescript
Promise<string | null>
```

**Exemplo:**
```typescript
import { getAccessToken } from '@/app/api/auth'

// Para fazer requisi√ß√µes autenticadas em Server Components
const token = await getAccessToken()

if (token) {
    // Fazer requisi√ß√£o com token
}
```

**Comportamento:**
- ‚úÖ Retorna token ou `null`
- ‚úÖ √ötil para requisi√ß√µes customizadas

---

## ‚úÖ Schemas Zod

### `loginSchema`

Valida dados de login.

**Schema:**
```typescript
z.object({
    email: z.string().email('Email inv√°lido').min(1, 'Email √© obrigat√≥rio'),
    password: z.string().min(1, 'Senha √© obrigat√≥ria'),
})
```

**Uso:**
```typescript
import { loginSchema } from '@/app/api/auth'

const result = loginSchema.safeParse({
    email: 'user@example.com',
    password: 'senha123'
})

if (!result.success) {
    console.error(result.error.errors)
}
```

---

### `recoverySchema`

Valida email para recupera√ß√£o de senha.

**Schema:**
```typescript
z.object({
    email: z.string().email('Email inv√°lido').min(1, 'Email √© obrigat√≥rio'),
})
```

---

### `resetPasswordSchema`

Valida redefini√ß√£o de senha.

**Schema:**
```typescript
z.object({
    token: z.string().min(1, 'Token √© obrigat√≥rio'),
    password: z.string().min(8, 'Senha deve ter no m√≠nimo 8 caracteres'),
    confirmPassword: z.string().min(1, 'Confirma√ß√£o obrigat√≥ria'),
}).refine((data) => data.password === data.confirmPassword, {
    message: 'As senhas n√£o conferem',
    path: ['confirmPassword'],
})
```

---

### `acceptInviteSchema`

Valida aceite de convite.

**Schema:**
```typescript
z.object({
    token: z.string().min(1, 'Token √© obrigat√≥rio'),
    name: z.string().min(3, 'Nome deve ter no m√≠nimo 3 caracteres'),
    password: z.string().min(8, 'Senha deve ter no m√≠nimo 8 caracteres'),
    confirmPassword: z.string().min(1, 'Confirma√ß√£o obrigat√≥ria'),
}).refine((data) => data.password === data.confirmPassword, {
    message: 'As senhas n√£o conferem',
    path: ['confirmPassword'],
})
```

---

## üîê Fluxo de Autentica√ß√£o

### Login
```
1. Usu√°rio preenche formul√°rio
2. Valida com loginSchema
3. Chama loginAction()
4. API retorna tokens + dados do usu√°rio
5. Tokens salvos em cookies httpOnly
6. Usu√°rio redirecionado
```

### Requisi√ß√µes Autenticadas
```
1. serverApi verifica cookie access_token
2. Adiciona header Authorization: Bearer {token}
3. API valida token
4. Retorna dados
```

### Refresh Token
```
1. API retorna 401 (token expirado)
2. Interceptor detecta 401
3. Chama refreshTokenAction()
4. Novo access_token salvo
5. Requisi√ß√£o original reenviada
```

### Logout
```
1. Chama logoutAction()
2. Cookies removidos
3. Usu√°rio redirecionado para login
```

---

## üéØ Exemplo Completo: Formul√°rio de Login

```typescript
'use client'

import { useState } from 'react'
import { useRouter } from 'next/navigation'
import { loginAction } from '@/app/api/auth'
import { loginSchema } from '@/app/api/auth'

export default function LoginForm() {
    const [email, setEmail] = useState('')
    const [password, setPassword] = useState('')
    const [error, setError] = useState('')
    const [loading, setLoading] = useState(false)
    const router = useRouter()
    
    const handleSubmit = async (e: React.FormEvent) => {
        e.preventDefault()
        setError('')
        setLoading(true)
        
        // Valida com Zod
        const validation = loginSchema.safeParse({ email, password })
        if (!validation.success) {
            setError(validation.error.errors[0].message)
            setLoading(false)
            return
        }
        
        // Chama Server Action
        const result = await loginAction({ email, password })
        
        if (result.success) {
            router.push('/app')
            router.refresh()
        } else {
            setError(result.error || 'Erro ao fazer login')
        }
        
        setLoading(false)
    }
    
    return (
        <form onSubmit={handleSubmit}>
            <input 
                type="email" 
                value={email}
                onChange={(e) => setEmail(e.target.value)}
                placeholder="Email"
            />
            <input 
                type="password" 
                value={password}
                onChange={(e) => setPassword(e.target.value)}
                placeholder="Senha"
            />
            {error && <p className="error">{error}</p>}
            <button type="submit" disabled={loading}>
                {loading ? 'Entrando...' : 'Entrar'}
            </button>
        </form>
    )
}
```

---

## üîó Links Relacionados

- [Documenta√ß√£o Geral de APIs](../../../docs/API.MD)
- [Criar Novo M√≥dulo](../../../docs/ai/CRIAR-NOVA-API.md)

---

## üí° Dicas

1. **Sempre use Server Actions** para auth (nunca client-side)
2. **Valide com Zod** antes de enviar para a action
3. **Trate erros** de forma amig√°vel para o usu√°rio
4. **Use `getCurrentUser()`** em Server Components
5. **Refresh autom√°tico** √© gerenciado pelos interceptors

üîí **Seguran√ßa em primeiro lugar!**

