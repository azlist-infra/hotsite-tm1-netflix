# ğŸ§­ Sistema de Menus Completo

DocumentaÃ§Ã£o unificada do sistema de menus com controle de roles, submenus e Server Components.

---

## ğŸ“¦ VisÃ£o Geral

Sistema inteligente de menus que:
- âœ… Filtra menus por permissÃ£o (roles)
- âœ… Suporta submenus hierÃ¡rquicos (dropdown)
- âœ… **NÃ£o pisca** ao navegar (Server + Client Components)
- âœ… Config centralizado
- âœ… Type-safe

---

## ğŸ—ï¸ Arquitetura

### **SeparaÃ§Ã£o Server/Client:**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  MenuApp.tsx (Server Component)       â”‚
â”‚  - Busca usuÃ¡rio no servidor          â”‚
â”‚  - Passa user para Client Component   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  MenuAppClient.tsx (Client Component) â”‚
â”‚  - Recebe user como prop              â”‚
â”‚  - Filtra menus (sem loading!)        â”‚
â”‚  - Renderiza com Chakra UI            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  MenuItemDropdown.tsx (Client)        â”‚
â”‚  - Dropdown interativo                â”‚
â”‚  - Chakra UI Menu                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Por que essa arquitetura?**
1. **Server Component** busca user (sem loading state)
2. **Client Component** renderiza UI (Chakra UI requer cliente)
3. **Resultado:** Sem piscar, sem loading, instantÃ¢neo! âœ¨

---

## ğŸ“„ Arquivos do Sistema

```
src/
â”œâ”€â”€ config/
â”‚   â””â”€â”€ menu.config.ts           â† Config centralizado
â”œâ”€â”€ layouts/menu/
â”‚   â”œâ”€â”€ MenuApp.tsx              â† Server Component (wrapper)
â”‚   â”œâ”€â”€ MenuAppClient.tsx        â† Client Component (renderiza)
â”‚   â””â”€â”€ MenuItemDropdown.tsx     â† Client Component (dropdown)
â””â”€â”€ app/api/auth/
    â””â”€â”€ auth.action.ts           â† getCurrentUser()
```

---

## âš™ï¸ ConfiguraÃ§Ã£o de Menus

### **Arquivo:** `src/config/menu.config.ts`

```typescript
export const menuItems: MenuItem[] = [
    // âœ… Menu normal (todos veem)
    {
        label: "Dashboard",
        href: "/app",
    },
    
    // âœ… Menu com roles (admin ou gestor)
    {
        label: "UsuÃ¡rios",
        href: "/app/admin/users",
        roles: ['admin', 'gestor'],
    },
    
    // âœ… Menu com submenu (apenas admin)
    {
        label: "Admin",
        requireAdmin: true,
        children: [
            {
                label: "Clientes",
                href: "/app/admin/clients",
            },
            {
                label: "ConfiguraÃ§Ãµes",
                href: "/app/admin/settings",
            },
        ],
    },
]
```

---

## ğŸ” Tipos de PermissÃ£o

### **1. Sem RestriÃ§Ã£o (PadrÃ£o)**

```typescript
{
    label: "Dashboard",
    href: "/app"
    // Sem roles/requireAdmin = todos autenticados veem
}
```

**Quem vÃª:** `admin`, `gestor`, `operador`, `assistente`

---

### **2. Por Roles**

```typescript
{
    label: "UsuÃ¡rios",
    href: "/app/users",
    roles: ['admin', 'gestor']  // â† Lista de roles permitidas
}
```

**Quem vÃª:** Apenas `admin` OU `gestor`  
**Quem NÃƒO vÃª:** `operador`, `assistente`

---

### **3. Apenas Admin**

```typescript
{
    label: "Clientes",
    href: "/app/clients",
    requireAdmin: true  // â† SÃ³ admin (isAdmin === true)
}
```

**Quem vÃª:** Apenas `admin`  
**Quem NÃƒO vÃª:** Todos os outros

---

### **4. Submenus com PermissÃµes**

```typescript
{
    label: "Admin",
    requireAdmin: true,  // â† PermissÃ£o do PAI
    children: [
        {
            label: "Clientes",
            href: "/app/clients",
            // Herda permissÃ£o do pai
        },
        {
            label: "Logs",
            href: "/app/logs",
            // Pode ter permissÃ£o prÃ³pria tambÃ©m
        },
    ],
}
```

**Regras:**
- PermissÃ£o do **pai Ã© verificada primeiro**
- Children podem ter **permissÃµes prÃ³prias**
- Pai sem children visÃ­veis Ã© **ocultado automaticamente**

---

## ğŸ¨ Interface MenuItem

```typescript
export interface MenuItem {
    /** Texto exibido no menu */
    label: string
    
    /** URL de destino (opcional se tiver children) */
    href?: string
    
    /** Submenus (opcional) */
    children?: MenuItem[]
    
    /** Roles permitidas (vazio = todos autenticados) */
    roles?: UserRole[]
    
    /** Se true, apenas administradores podem ver */
    requireAdmin?: boolean
    
    /** Ãcone (opcional, para futuro) */
    icon?: string
}
```

| Campo | Tipo | ObrigatÃ³rio | DescriÃ§Ã£o |
|-------|------|-------------|-----------|
| `label` | `string` | âœ… | Texto do menu |
| `href` | `string` | âŒ | URL (obrigatÃ³rio se nÃ£o tiver `children`) |
| `children` | `MenuItem[]` | âŒ | Submenus (dropdown) |
| `roles` | `UserRole[]` | âŒ | Lista de roles permitidas |
| `requireAdmin` | `boolean` | âŒ | Se `true`, apenas admin |

---

## ğŸ“Š Matriz de PermissÃµes Atual

| Menu | Submenu | Admin | Gestor | Operador | Assistente |
|------|---------|-------|--------|----------|------------|
| **Dashboard** | - | âœ… | âœ… | âœ… | âœ… |
| **Eventos** | - | âœ… | âœ… | âœ… | âœ… |
| **UsuÃ¡rios** | - | âœ… | âœ… | âŒ | âŒ |
| **Admin** | (Dropdown) | âœ… | âŒ | âŒ | âŒ |
| â†³ | Clientes | âœ… | âŒ | âŒ | âŒ |

---

## ğŸ¯ VisualizaÃ§Ã£o por Tipo de UsuÃ¡rio

### **Admin:**
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Dashboard  Eventos  UsuÃ¡rios  Admin â–¼ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                     â†“
                              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                              â”‚  Clientes   â”‚
                              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### **Gestor:**
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Dashboard  Eventos  UsuÃ¡rios â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### **Operador/Assistente:**
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Dashboard  Eventos  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸš€ Como Adicionar Novo Menu

### **Exemplo 1: Menu Simples**

```typescript
// Edite: src/config/menu.config.ts

export const menuItems: MenuItem[] = [
    // ... menus existentes
    
    {
        label: "RelatÃ³rios",
        href: "/app/reports",
        roles: ['admin', 'gestor'],  // â† Apenas admin e gestor
    },
]
```

**Pronto!** Menu aparece automaticamente para admin e gestor.

---

### **Exemplo 2: Menu com Submenu**

```typescript
{
    label: "RelatÃ³rios",
    roles: ['admin', 'gestor'],
    children: [
        {
            label: "Financeiro",
            href: "/reports/finance",
            requireAdmin: true,  // â† SÃ³ admin vÃª este
        },
        {
            label: "Vendas",
            href: "/reports/sales",
            // Admin e gestor veem este
        },
    ],
}
```

**Resultado:**
- **Admin:** VÃª "Financeiro" + "Vendas"
- **Gestor:** VÃª apenas "Vendas"
- **Operador:** NÃ£o vÃª o menu "RelatÃ³rios"

---

### **Exemplo 3: Adicionar Item ao Submenu Existente**

```typescript
{
    label: "Admin",
    requireAdmin: true,
    children: [
        { label: "Clientes", href: "/app/admin/clients" },
        { label: "Logs", href: "/app/admin/logs" },        // â† NOVO
        { label: "Backup", href: "/app/admin/backup" },    // â† NOVO
    ],
}
```

---

## ğŸ”„ Fluxo de RenderizaÃ§Ã£o (Sem Piscar!)

```
1. NavegaÃ§Ã£o acontece
   â†“
2. Next.js renderiza novo layout no SERVIDOR
   â†“
3. MenuApp.tsx (Server) executa:
   - getCurrentUser() busca do cookie (server-side)
   - Passa user para MenuAppClient
   â†“
4. MenuAppClient.tsx (Client) renderiza:
   - getVisibleMenuItems(user) filtra menus
   - Renderiza com Chakra UI
   â†“
5. HTML completo enviado ao navegador
   â†“
6. Menu aparece INSTANTANEAMENTE (sem piscar!)
   â†“
7. Hydration: Dropdown torna-se interativo
```

**Resultado:** Menu **SEMPRE visÃ­vel**, sem loading, sem piscar! âœ¨

---

## ğŸ’¡ Por Que NÃ£o Pisca?

### **âŒ SoluÃ§Ã£o Antiga (Piscava):**

```typescript
'use client'

export function MenuApp() {
    const { user, isLoading } = useCurrentUser()  // â† useEffect no cliente
    
    if (isLoading) return null  // â† Menu desaparece! PISCA!
    
    return <Menu user={user} />
}
```

**Problema:** `isLoading = true` durante 50-200ms em **TODA navegaÃ§Ã£o**.

---

### **âœ… SoluÃ§Ã£o Atual (NÃ£o Pisca):**

```typescript
// MenuApp.tsx (Server)
export async function MenuApp() {
    const user = await getCurrentUser()  // â† Server-side, sem loading
    return <MenuAppClient user={user} />
}

// MenuAppClient.tsx (Client)
'use client'
export function MenuAppClient({ user }: Props) {
    const menus = getVisibleMenuItems(user)  // â† InstantÃ¢neo!
    return <Menu items={menus} />
}
```

**Vantagem:**
1. User buscado no **servidor** (sem loading state)
2. Passado como **prop** para Client Component
3. Client Component renderiza **instantaneamente**
4. **SEM PISCAR!** ğŸ‰

---

## ğŸ“š Helpers DisponÃ­veis

### **1. canViewMenuItem(item, user)**

Verifica se o usuÃ¡rio pode ver um item especÃ­fico.

```typescript
import { canViewMenuItem } from '@/config/menu.config'

const canView = canViewMenuItem(menuItem, user)
// Retorna: boolean
```

---

### **2. getVisibleMenuItems(user)**

Retorna todos os itens visÃ­veis para o usuÃ¡rio, com children filtrados.

```typescript
import { getVisibleMenuItems } from '@/config/menu.config'

const visibleItems = getVisibleMenuItems(user)
// Retorna: MenuItem[]
```

---

## ğŸ§ª Como Testar

### **Teste 1: Menu NÃ£o Pisca**
1. Acesse `/app`
2. Navegue para `/app/admin/users`
3. Navegue para `/app/event`
4. **Resultado:** Menu SEMPRE visÃ­vel âœ¨

### **Teste 2: Dropdown Funciona**
1. Login como admin
2. Clique em "Admin" no menu
3. Dropdown abre com "Clientes"
4. Clique em "Clientes"
5. Navega para `/app/admin/clients`

### **Teste 3: PermissÃµes OK**
- **Admin:** VÃª "Admin" com dropdown
- **Gestor:** VÃª "UsuÃ¡rios", NÃƒO vÃª "Admin"
- **Operador:** VÃª apenas "Dashboard" e "Eventos"

---

## ğŸ¯ Server vs Client Components

### **Use Server Component quando:**
- âœ… Buscar dados de banco/API
- âœ… Acessar cookies/headers
- âœ… **Evitar piscar em navegaÃ§Ã£o**
- âŒ NÃƒO pode usar Chakra UI diretamente

### **Use Client Component quando:**
- âœ… Renderizar Chakra UI
- âœ… Precisar de interaÃ§Ã£o (onClick, onChange)
- âœ… Usar hooks (useState, useEffect)
- âœ… Precisar de browser APIs

### **Nossa SoluÃ§Ã£o (HÃ­brida):**
- **Server:** Busca dados
- **Client:** Renderiza UI
- **Melhor dos dois mundos!** ğŸš€

---

## ğŸ¨ Exemplos PrÃ¡ticos Completos

### **Exemplo 1: Menu Admin Completo**

```typescript
{
    label: "Admin",
    requireAdmin: true,
    children: [
        { label: "Clientes", href: "/app/admin/clients" },
        { label: "UsuÃ¡rios", href: "/app/admin/users" },
        { label: "ConfiguraÃ§Ãµes", href: "/app/admin/settings" },
        { label: "Logs", href: "/app/admin/logs" },
        { label: "Backup", href: "/app/admin/backup" },
    ],
}
```

---

### **Exemplo 2: Ferramentas com PermissÃµes Mistas**

```typescript
{
    label: "Ferramentas",
    // Sem restriÃ§Ã£o no pai = todos veem dropdown
    children: [
        {
            label: "Calculadora",
            href: "/tools/calculator",
            // Todos veem
        },
        {
            label: "Gerador de PDF",
            href: "/tools/pdf",
            roles: ['admin', 'gestor'],  // â† SÃ³ admin e gestor
        },
    ],
}
```

**Resultado:**
- **Admin/Gestor:** Veem 2 itens
- **Operador:** VÃª apenas "Calculadora"

---

### **Exemplo 3: Menu Apenas para Operadores**

```typescript
{
    label: "Tarefas",
    href: "/app/tasks",
    roles: ['operador', 'assistente'],  // â† SÃ³ operadores
}
```

**Resultado:**
- **Admin:** NÃƒO vÃª (nÃ£o estÃ¡ na lista)
- **Operador:** VÃª
- **Assistente:** VÃª

ğŸ’¡ **Dica:** Se quiser que admin tambÃ©m veja, adicione `'admin'` na lista!

---

## ğŸ”§ Troubleshooting

### **Problema: Menu ainda pisca**

**SoluÃ§Ã£o:** Verifique se `HeaderApp` ou `LayoutApp` nÃ£o sÃ£o Client Components:

```typescript
// âŒ Errado
'use client'
export function HeaderApp() {
    return <header><MenuApp /></header>
}

// âœ… Correto
export function HeaderApp() {
    return <header><MenuApp /></header>
}
```

---

### **Problema: Erro "Cannot find module in React Client Manifest"**

**Causa:** Tentando usar Chakra UI em Server Component

**SoluÃ§Ã£o:** Use a arquitetura hÃ­brida:
- `MenuApp.tsx` = Server (busca user)
- `MenuAppClient.tsx` = Client (renderiza Chakra UI)

---

### **Problema: Dropdown nÃ£o funciona**

**SoluÃ§Ã£o:** Verifique se `MenuItemDropdown.tsx` tem `'use client'`:

```typescript
'use client'  // â† ObrigatÃ³rio!

export function MenuItemDropdown() { ... }
```

---

## âš¡ Performance

| MÃ©trica | Antes (Client) | Depois (HÃ­brido) |
|---------|----------------|------------------|
| First Render | 200ms | 0ms |
| NavegaÃ§Ã£o | 150ms | 0ms |
| Piscar | âŒ Sim | âœ… NÃ£o |
| Loading State | âŒ Sim | âœ… NÃ£o |

**Melhoria:** ~350ms mais rÃ¡pido! ğŸš€

---

## âœ… Checklist para Adicionar Novo Menu

- [ ] Edite `src/config/menu.config.ts`
- [ ] Defina `label` e `href`
- [ ] Configure permissÃµes (`roles` ou `requireAdmin`)
- [ ] (Opcional) Adicione `children` para submenu
- [ ] Teste com diferentes tipos de usuÃ¡rio
- [ ] Verifique navegaÃ§Ã£o (nÃ£o pisca)
- [ ] Verifique dropdown (se tiver submenu)

---

## ğŸ¨ Futuras Melhorias (Opcional)

### **1. Ãcones nos Menus**

```typescript
import { LuHome, LuUsers, LuBuilding2 } from 'react-icons/lu'

{
    label: "Dashboard",
    href: "/app",
    icon: LuHome,  // â† Adicionar Ã­cone
}
```

### **2. Badge/Contador**

```typescript
{
    label: "NotificaÃ§Ãµes",
    href: "/app/notifications",
    badge: 5,  // â† Mostra "(5)" ou badge visual
}
```

### **3. Divider Entre Itens**

```typescript
children: [
    { label: "Clientes", href: "/app/clients" },
    { type: "divider" },  // â† Separador visual
    { label: "Sair", href: "/logout" },
]
```

### **4. Submenu de 3 NÃ­veis**

```typescript
{
    label: "Admin",
    children: [
        {
            label: "Sistema",
            children: [  // â† 3Âº nÃ­vel
                { label: "Logs", href: "/admin/logs" },
            ]
        }
    ]
}
```

---

## ğŸ”— Arquivos Relacionados

- **Config:** `src/config/menu.config.ts`
- **Server Wrapper:** `src/layouts/menu/MenuApp.tsx`
- **Client Component:** `src/layouts/menu/MenuAppClient.tsx`
- **Dropdown:** `src/layouts/menu/MenuItemDropdown.tsx`
- **Auth:** `src/app/api/auth/auth.action.ts`
- **Types:** `src/app/api/auth/auth.types.ts`

---

## ğŸ‰ ConclusÃ£o

**Sistema de Menus Completo:**
- âœ… Centralizado em config file
- âœ… Controle inteligente por roles
- âœ… Suporta submenus hierÃ¡rquicos
- âœ… **NÃ£o pisca** ao navegar (hÃ­brido Server + Client)
- âœ… Type-safe e escalÃ¡vel
- âœ… Performance otimizada (~350ms mais rÃ¡pido)
- âœ… FÃ¡cil adicionar novos menus (1 linha no config)

**Seus menus agora sÃ£o profissionais, rÃ¡pidos e seguros!** ğŸš€ğŸ”âœ¨

---

## ğŸ“– ReferÃªncias

- [Next.js Server Components](https://nextjs.org/docs/app/building-your-application/rendering/server-components)
- [Client Components](https://nextjs.org/docs/app/building-your-application/rendering/client-components)
- [Composition Patterns](https://nextjs.org/docs/app/building-your-application/rendering/composition-patterns)
- [Chakra UI v3](https://www.chakra-ui.com/)

