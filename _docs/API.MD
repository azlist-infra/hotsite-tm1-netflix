# ğŸŒ Arquitetura de APIs - DocumentaÃ§Ã£o Geral

DocumentaÃ§Ã£o da estrutura e funcionamento das chamadas de API no projeto Next.js 15.

---

## ğŸ“ Estrutura dos MÃ³dulos

```
src/app/api/
â”œâ”€â”€ _shared/                      â† Tipos e utilitÃ¡rios compartilhados
â”‚   â”œâ”€â”€ index.ts                 
â”‚   â”œâ”€â”€ types.ts                  â† ApiResponse, ActionResponse, ApiError, etc
â”‚   â””â”€â”€ error-handler.ts          â† Tratamento de erros padronizado
â”‚
â”œâ”€â”€ auth/                         â† MÃ³dulo de autenticaÃ§Ã£o
â”‚   â”œâ”€â”€ index.ts                  â† Barrel export
â”‚   â”œâ”€â”€ auth.types.ts             â† Interfaces TypeScript
â”‚   â”œâ”€â”€ auth.schemas.ts           â† ValidaÃ§Ãµes Zod
â”‚   â”œâ”€â”€ auth.action.ts            â† Server Actions
â”‚   â””â”€â”€ API-AUTH.MD              â† DocumentaÃ§Ã£o especÃ­fica
â”‚
â”œâ”€â”€ clients/                      â† MÃ³dulo de clientes
â”‚   â”œâ”€â”€ index.ts
â”‚   â”œâ”€â”€ clients.types.ts
â”‚   â”œâ”€â”€ clients.schemas.ts
â”‚   â”œâ”€â”€ clients.action.ts         â† Server Actions
â”‚   â”œâ”€â”€ clients.service.ts        â† Client Service
â”‚   â”œâ”€â”€ useClients.ts            â† Hooks React Query
â”‚   â””â”€â”€ API-CLIENTS.MD
â”‚
â””â”€â”€ users/                        â† MÃ³dulo de usuÃ¡rios
    â”œâ”€â”€ index.ts
    â”œâ”€â”€ users.types.ts
    â”œâ”€â”€ users.schemas.ts
    â”œâ”€â”€ users.action.ts
    â”œâ”€â”€ users.service.ts
    â”œâ”€â”€ useUsers.ts
    â””â”€â”€ API-USERS.MD
```

---

## ğŸ—ï¸ Arquitetura em Camadas

Cada mÃ³dulo segue uma arquitetura em **4 camadas principais**:

### **1. `*.types.ts` - DefiniÃ§Ãµes de Tipos**
**O que faz**: Define todas as interfaces TypeScript do mÃ³dulo

**ContÃ©m**:
- Interfaces das entidades (`Client`, `User`)
- DTOs (Data Transfer Objects) para criaÃ§Ã£o/atualizaÃ§Ã£o
- Tipos de resposta da API
- Tipos de filtros e parÃ¢metros
- Re-exportaÃ§Ãµes de tipos compartilhados

**Quando usar**: Sempre que precisar importar tipos

**Exemplo**:
```typescript
import type { User, CreateUserDto } from '@/app/api/users'
```

---

### **2. `*.schemas.ts` - ValidaÃ§Ãµes Zod**
**O que faz**: Define schemas de validaÃ§Ã£o usando Zod

**ContÃ©m**:
- Schemas para criaÃ§Ã£o (`createXxxSchema`)
- Schemas para atualizaÃ§Ã£o (`updateXxxSchema`)
- Schemas para filtros (`xxxFiltersSchema`)
- Tipos inferidos dos schemas

**Quando usar**: Em formulÃ¡rios e validaÃ§Ãµes

**Exemplo**:
```typescript
import { createUserSchema } from '@/app/api/users'

const result = createUserSchema.safeParse(formData)
```

---

### **3. `*.action.ts` - Server Actions**
**O que faz**: FunÃ§Ãµes que rodam **exclusivamente no servidor** (Next.js 15)

**Usa**: `serverApi` (fetch no servidor)

**Quando usar**: 
- Server Components que precisam buscar dados
- FormulÃ¡rios sem necessidade de React Query
- OperaÃ§Ãµes simples sem cache no cliente
- Quando precisa de seguranÃ§a extra (acesso a cookies, tokens)

**CaracterÃ­sticas**:
- `'use server'` no topo
- Acesso direto aos cookies (auth)
- Pode fazer `revalidatePath()` para atualizar cache do Next.js
- Usa `handleActionError` para tratamento consistente

**Exemplo**:
```typescript
import { getUsersAction } from '@/app/api/users'

// Em Server Component
const result = await getUsersAction()
if (result.success) {
    console.log(result.data)
}
```

---

### **4a. `*.service.ts` - Client-Side Service**
**O que faz**: FunÃ§Ãµes para fazer requisiÃ§Ãµes **do navegador**

**Usa**: `apiClient` (fetch + interceptors)

**Quando usar**: 
- Com TanStack Query/React Query
- Client Components que precisam de cache/invalidaÃ§Ã£o
- OperaÃ§Ãµes que se beneficiam de loading/error states automÃ¡ticos

**CaracterÃ­sticas**:
- Retorna dados puros (nÃ£o wrapped em ActionResponse)
- LanÃ§a exceÃ§Ãµes em caso de erro
- Token gerenciado por interceptors

**Exemplo**:
```typescript
import { usersService } from '@/app/api/users'

// Usado dentro de hooks ou funÃ§Ãµes client-side
const users = await usersService.getAll()
```

---

### **4b. `use*.ts` - Hooks React Query**
**O que faz**: Hooks customizados usando TanStack Query

**Usa**: `*.service.ts`

**Fornece**:
- `useXxxs()`, `useXxx(id)` - queries com cache
- `useCreateXxx()`, `useUpdateXxx()` - mutations
- Query keys organizadas para invalidaÃ§Ã£o
- InvalidaÃ§Ã£o automÃ¡tica de cache apÃ³s mutations

**Vantagens**: 
- Cache inteligente
- Refetch automÃ¡tico
- Loading/error states
- Optimistic updates

**Exemplo**:
```typescript
'use client'
import { useUsers } from '@/app/api/users'

function UsersList() {
    const { data: users, isLoading, error } = useUsers()
    
    if (isLoading) return <Spinner />
    if (error) return <Error />
    return <Table data={users} />
}
```

---

## ğŸ”„ Quando Usar Cada Camada?

| Camada | Onde roda | Usa com | Quando usar |
|--------|-----------|---------|-------------|
| `*.types.ts` | - | Tudo | Sempre (tipagens) |
| `*.schemas.ts` | Cliente/Servidor | FormulÃ¡rios | ValidaÃ§Ã£o de dados |
| `*.action.ts` | Servidor | Server Components | Dados no SSR, forms simples, seguranÃ§a |
| `*.service.ts` | Cliente | React Query | NÃ£o use diretamente! |
| `use*.ts` | Cliente | Components | Cache, loading states, interatividade |

---

## ğŸ“¦ Sistema de Imports

### **Barrel Exports (`index.ts`)**

Cada mÃ³dulo tem um `index.ts` que centraliza todas as exportaÃ§Ãµes:

```typescript
// src/app/api/users/index.ts
export * from './users.types'
export * from './users.action'
export * from './users.service'
export * from './users.schemas'
export * from './useUsers'
```

### **Imports Limpos**

**âŒ Antes (verboso):**
```typescript
import { User } from '@/app/api/users/users.types'
import { getUsersAction } from '@/app/api/users/users.action'
import { useUsers } from '@/app/api/users/useUsers'
```

**âœ… Agora (limpo):**
```typescript
import { User, getUsersAction, useUsers } from '@/app/api/users'
```

---

## ğŸ› ï¸ Tipos Compartilhados (`_shared`)

### **`_shared/types.ts`**

Tipos reutilizÃ¡veis em todos os mÃ³dulos:

```typescript
// Resposta padrÃ£o da API
interface ApiResponse<T> {
    success: boolean
    message?: string
    data: T
}

// Resposta de Server Actions
interface ActionResponse<T = void> {
    success: boolean
    error?: string
    data?: T
}

// Erro individual da API
interface ApiError {
    code: string
    description: string
    field?: string
}

// Estrutura de erro completa
interface ApiErrorData {
    message?: string
    errors?: ApiError[]
}

// Resposta de erro (RFC 7807)
interface ApiErrorResponse {
    errors: ApiError[]
}

// Filtros base para listagens
interface BaseFilters {
    search?: string
    page?: number
    limit?: number
    sortBy?: string
    sortOrder?: 'asc' | 'desc'
}
```

### **`_shared/error-handler.ts`**

UtilitÃ¡rios para tratamento consistente de erros:

```typescript
/**
 * Formata um erro da API em mensagem amigÃ¡vel
 */
function formatApiError(error: ServerApiError): string

/**
 * Trata erros de forma consistente
 */
function handleActionError<T>(
    error: unknown,
    defaultMessage?: string
): ActionResponse<T>

/**
 * Adiciona mensagens de erro customizadas
 */
function addErrorMessages(messages: Record<string, string>): void
```

**Uso em Server Actions:**
```typescript
export async function createUserAction(data: CreateUserDto) {
    try {
        // ... lÃ³gica
    } catch (error) {
        return handleActionError(error, 'Erro ao criar usuÃ¡rio')
    }
}
```

---

## ğŸ¯ Fluxo de Dados

### **Server-Side (SSR)**
```
Server Component
    â†“
Server Action (*.action.ts)
    â†“
serverApi (fetch no servidor)
    â†“
API Externa
    â†“
Response â†’ ActionResponse
    â†“
Server Component renderiza
```

### **Client-Side (CSR com Cache)**
```
Client Component
    â†“
Hook (use*.ts)
    â†“
Service (*.service.ts)
    â†“
apiClient (fetch no browser)
    â†“
API Externa
    â†“
Response â†’ Cache (React Query)
    â†“
Component re-renderiza
```

---

## ğŸ” AutenticaÃ§Ã£o

### **Server-Side**
- Usa cookies httpOnly (mais seguro)
- Token enviado automaticamente pelo `serverApi`
- `requireAuth: true` nas actions

### **Client-Side**
- Token gerenciado por interceptors
- Refresh automÃ¡tico em 401
- Logout automÃ¡tico se refresh falhar

---

## ğŸ“Š ComparaÃ§Ã£o: Service vs Hook

### **`*.service.ts` - FunÃ§Ãµes Puras**

```typescript
// âœ… FunÃ§Ã£o pura - retorna Promise
export const usersService = {
    getAll: async (): Promise<User[]> => {
        const response = await apiClient.get(...)
        return response.data
    }
}
```

**CaracterÃ­sticas**:
- âœ… FunÃ§Ãµes JavaScript puras
- âœ… Sem estado (stateless)
- âœ… Sem hooks do React
- âœ… Pode ser usado fora de componentes
- âŒ NÃ£o tem cache automÃ¡tico
- âŒ VocÃª gerencia loading/error manualmente

**Quando usar**:
- âœ… Como "matÃ©ria-prima" para os hooks
- âŒ NÃƒO use direto em componentes React

---

### **`use*.ts` - Hooks React Query**

```typescript
// âœ… Hook - gerencia estado, cache, refetch
export function useUsers() {
    return useQuery({
        queryKey: ['users'],
        queryFn: () => usersService.getAll(),
        staleTime: 5 * 60 * 1000,
    })
}
```

**CaracterÃ­sticas**:
- âœ… Hook do React
- âœ… Cache inteligente
- âœ… Loading/error states automÃ¡ticos
- âœ… Refetch automÃ¡tico
- âœ… InvalidaÃ§Ã£o de cache
- âŒ SÃ³ funciona em componentes React

**Quando usar**:
- âœ… Em componentes React (recomendado!)

---

## ğŸ¨ Exemplos PrÃ¡ticos

### **Exemplo 1: Listar em Server Component**

```typescript
// app/users/page.tsx
import { getUsersAction } from '@/app/api/users'

export default async function UsersPage() {
    const result = await getUsersAction()
    
    if (!result.success) {
        return <Error message={result.error} />
    }
    
    return <UsersList users={result.data} />
}
```

### **Exemplo 2: Listar em Client Component (com cache)**

```typescript
'use client'
import { useUsers } from '@/app/api/users'

export default function UsersPage() {
    const { data: users, isLoading, error } = useUsers()
    
    if (isLoading) return <Spinner />
    if (error) return <Error message={error.message} />
    
    return <UsersList users={users} />
}
```

### **Exemplo 3: Criar com Mutation**

```typescript
'use client'
import { useCreateUser } from '@/app/api/users'
import { createUserSchema } from '@/app/api/users'

export default function CreateUserForm() {
    const { mutate, isPending } = useCreateUser()
    
    const handleSubmit = (formData: CreateUserDto) => {
        // Valida com Zod
        const result = createUserSchema.safeParse(formData)
        if (!result.success) {
            // Mostra erros
            return
        }
        
        mutate(result.data, {
            onSuccess: () => {
                toast.success('UsuÃ¡rio criado!')
                // Cache Ã© invalidado automaticamente!
            },
            onError: (error) => {
                toast.error(error.message)
            }
        })
    }
    
    return <form onSubmit={handleSubmit}>...</form>
}
```

---

## ğŸ“š DocumentaÃ§Ã£o dos MÃ³dulos

Cada mÃ³dulo possui sua documentaÃ§Ã£o especÃ­fica:

- **Auth**: `src/app/api/auth/API-AUTH.MD`
- **Clients**: `src/app/api/clients/API-CLIENTS.MD`
- **Users**: `src/app/api/users/API-USERS.MD`

---

## ğŸ”— Links Ãšteis

- [Criar Novo MÃ³dulo](./ai/CRIAR-NOVA-API.md) - Guia completo
- [Next.js 15 Server Actions](https://nextjs.org/docs/app/building-your-application/data-fetching/server-actions-and-mutations)
- [TanStack Query](https://tanstack.com/query/latest)
- [Zod Validation](https://zod.dev/)

---

## ğŸ¯ Regras de Ouro

1. **âœ… Use tipos compartilhados**: Sempre importe de `_shared`
2. **âœ… Sem duplicaÃ§Ã£o**: Nunca recrie tipos que jÃ¡ existem
3. **âœ… Imports limpos**: Use barrel exports (`from '@/app/api/xxx'`)
4. **âœ… Tratamento de erros**: Use `handleActionError` nas Server Actions
5. **âœ… Cache inteligente**: Defina `staleTime` apropriado nos hooks
6. **âœ… ValidaÃ§Ã£o Zod**: Use schemas antes de enviar para API
7. **âœ… Documente tudo**: Mantenha API-[MODULO].MD atualizado

---

## ğŸ‰ ConclusÃ£o

Esta arquitetura oferece:
- âœ… **Type-safety** completo
- âœ… **SeguranÃ§a** (Server Actions + httpOnly cookies)
- âœ… **Performance** (cache inteligente com React Query)
- âœ… **Escalabilidade** (padrÃ£o consistente para novos mÃ³dulos)
- âœ… **Flexibilidade** (Server Actions OU React Query conforme necessidade)
- âœ… **Manutenibilidade** (cÃ³digo organizado e documentado)

ğŸš€ **Pronto para criar APIs de forma profissional!**

